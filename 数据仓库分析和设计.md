# 数据仓库分析和设计

>分析技术常被用来发掘BI数据需求   
     
第三范式ER建模和维度建模都是数据库设计技术，但是在数据仓库设计方面，维度建模比第三范式ER建模更为有效。然而在决定使用哪一种方式来设计数据结构和满足BI数据需求之前，我们还需要某种需求分析技术来发掘需求。目前最常用的两类需求分析方法分别为数据驱动型分析（也叫供应侧驱动）和应用驱动型分析（也叫需求侧驱动）。然而大部分的现代数仓设计理念都倡导混合使用以上两种方式。下图描绘了企业数仓和数据集市在分析方式（数据驱动或应用驱动）和设计方式（维度建模或第三范式ER建模）两方面的差异。   
![image](https://user-images.githubusercontent.com/20431533/112643986-e17d2d00-8e7f-11eb-8419-84f900e89ba4.png)

## 1. 数据驱动型分析方法   

>纯粹的数据驱动型分析会拒绝用户过早地参与需求分析过程   

数据驱动型分析方法是通过分析业务数据源来获取数据需求。当时的数仓设计过程被认为是使用ER建模技术，将数据源重构成更完美的3第三范式模型的过程，早期很多IT部门都采用这种方式主导数仓建设，设计师会避免用户参与进来。当且仅当在数仓建设完成后，IT部门才会向BI用户问询需求。   
不幸的是，如果没有用户方输入需求范围和需求优先级，这些早期的数仓设计不仅耗时、成本高昂，而且产出的结果有可能不可用，即不符合BI用户方的需求。更甚的是，由于该种设计思路受OLTP的数据建模思路严重影响，产出的数据仓库在应对查询和支撑关键业务问题时表现得差强人意。后来的事实也证明，纯粹的数据驱动型分析和设计被认为是“痴人说梦”和“单方面的一厢情愿”，最终还是被混合型需求分析方式所取代。在混合型分析方式中，我们需要统一考虑用户需求、数据源和维度建模等各种因素。

>封装式应用是尤其具有分析挑战的数据源   

数据探查（Data Profiling）工具和方法极大地推进了数据驱动型分析的发展，但即使如此，随着业务数据模型复杂度的不断提升，数据驱动型分析方法依然问题重重。尤其当业务系统是Packaged APP时，譬如基于高度通用数据模型的ERP系统。   

>信息技术部门的人员非常推崇数据驱动型分析      

然而即使面临着这些问题，由于数据驱动型分析方法不需要IT人员和BI相关利益者有太多的接触，因此依然有很多数仓项目将该方法当作需求分析手段。   

## 2. 报表驱动型分析方法    

>应用需求是在小范围内对潜在BI用户进行访谈所获取的      

我们在使用报表驱动型分析方法时，是通过分析BI用户的报表需求来挖掘数据需求。这些需求都是通过小范围或者一次一人的方式，和相关利益者的访谈来获取的。经过一轮轮的访谈会议，我们不断回顾BI分析师的采访日记和详细报告定义，最终产出一个经过确认的数据需求列表，该需求列表当然需要经过数据验证。最后，需求文档还需要让相关利益者参与确认，而文档一旦被确认，需求文档就开始被用于驱动数据建模以及随后的BI应用开发。   

>用户的参与让数据仓库建设更成功   

报表驱动型分析方法将数据仓库的设计重心聚焦在相关利益者最急迫的报表需求上，因此只要仔细管理需求范围，就能及时和成功地交付部署。

>不断增长的BI报表需求很难被一次性提前收集完毕      

美中不足的是，报表驱动型分析方法也有其缺点：为了获取集团级或者跨部门视角的数据需求，数据产品经理不得不耗费更多时间来和更多的相关利益者展开访谈。更进一步的，如果想让相关利益者超越“下一个版本”来详细描述更长远的需求构想，则对数据产品经理的访谈技巧提出了更多要求。   
即使是有着充足时间预算且经验丰富的数据产品经理，依然可能会在需求收集过程中循环往复，原因在于，具体的BI需求在本质上就是不断增长的：它们需要层层引导和推进。而BI用户很难超越“下一个版本”来构想未来的数据需求，一方面是因为未来的需求往往依赖于“下一个版本”解决方案，另一方面则是需求灵感依赖于解决方案给BI用户的启发。当项目进程顺利走到需求确认环节时，数据产品经理将需求反馈给业务利益相关者，以此寻求相关利益者在想法上的一致，则更是一个漫长的过程。

>过于聚焦于当前的数据需求会导致不灵活的维度模型   

过于依赖报表驱动型分析方法，从长远上看，会导致初期成功的的数仓设计无法适应未来变化。尤其是缺乏经验的建模人员，如果只为满足当前需求，则产出的设计会更是缺乏灵活性。而实际上，我们应该要求建模人员把眼前需求视作线索，要谋求更进一步地挖掘真实业务过程，发现真实需求。另一个令人感到不适的原因还包括初期需求分析的时长，数据产品经理可能没有充足预算和意愿去快速迭代和发掘不断演变的BI需求。   

因以上两个因素而产出的不灵活设计，也导致一些行业专家有失公允地给维度建模贴上过于以报表为中心的标签：他们认为，维度建模只适用于面向部门层级数据集市的数据需求，而不适用与全局企业级的数据仓库设计。这其实是一个错误的误导。因为当维度建模方法以正确、增量和迭代的方法去建模业务过程的原子级细节，而非机械地逆向拆分工程师的总结报表需求时，维度建模并不存在以上问题。

## 3. 主动型DW/BI分析和设计    

> 早期的数仓是被动地应对OLTP的报表问题   

在过去，不管在技术上还是在建设时间上，数据仓库建设都是落后于OLTP开发的。数据仓库的建设往往在业务系统建成并运行较长一段时间后才开始，这种延后建设被认为不利于报表分析工作，同时也导致了重要的BI任务堆积如山。OLTP和DW/BI之间的延后被动的关系如图所示。   
![image](https://user-images.githubusercontent.com/20431533/112650046-f957af80-8e85-11eb-8cdd-eaeb52e0e170.png)

>OLTP和DW之间的差距正在消失   

今天，数仓的发展进度已经逐渐跟上并表现得更为主动。原处于两个独立世界中的OLTP和数据仓库正逐渐成为两个平行世界：OLTP和数据仓库需要同步建设，这个新的关系如图所示。   
![image](https://user-images.githubusercontent.com/20431533/112650323-3754d380-8e86-11eb-9d47-14580da8963b.png)

>主动型数仓设计解决了运营需求，避免了临时性解决方案的产出，并预先考虑了BI的性能问题   

数据仓库从被动稳定过渡为主动的原因如下：数据仓库正变得更加的“业务化”，业务系统和数据仓库之间的差距（绝大部分是技术）也正变得越来越模糊。复杂的业务系统往往需要利用近实时的BI分析能力，相关利益者也需要一个一站式的全报表服务方案，而且目前这个趋势越发明显。  

很多组织（特别是那些已经获得数据仓库成果的组织）已经意识到，迟早每个核心的业务系统都需要配套的数据集市，或者需要集成一个独立的数仓。BI相关利益者不希望使用临时性报表解决方案，更不想忍受BI分析任务的堆积。   

### 3.1. 主动型数仓建设的优势    

>主动型数仓设计可提升BI系统的数据可得性 
  
如果数仓设计预先考虑业务数据建模的细节，那么BI相关利益者就可以更好地规划数据建设工作。譬如，BI分析人员应该在业务系统处在建设、优化等易于合并和调整的阶段时，就开始制定理想的数据需求。   

这个对强制类数据的设计尤为重要。某些重要的BI数据字段，在纯粹的运营视角看来是不重要或者可选的，但在主动型设计下，这些重要字段可被确定为非空字段以及必须在业务系统运行的第一天开始就必须保存，这样可避免业务系统开发人员先入为主（非故意）地对重要字段的差异化理解。由此看来，我们应该鼓励敏捷OLTP的开发团队尽早拥抱“早期变化” 。  

>主动型数仓设计可简化ETL数据获取流程的变动影响   

如果数据源没有稳定的访问途径，我们往往很难或者不可能建立ETL流程。但也恰恰因为数据源还未确定或者在更新，敏捷的ETL团队才有机会定义“完美”的数据抽取接口规范（需要依赖主动型数仓设计），然后将接口规范传递给OLTP开发团队。这正是ETL设计者在数据源中植入“数据变动监测功能”（如一致性时间戳和更新理由代码等）的绝佳机会。如此一来，ETL流程环节便可监测数据变动和变动原因（是历史正确的值有变动还是因为修复了数据错误）。很多时候，即使数据源的数据模型还未确定，只要ETL设计者和OLTP设计者能够在平面文件的数据提取格式上保持一致，就可以继续推进ETL开发工作。

### 3.2. 主动数仓设计面临的挑战    

>主动型分析开始于数据存在前      

虽然主动型设计对数仓建设来说有巨大的潜在优势，但是真实数据源的滞后也预示着对数仓设计者诸多挑战：在接触到任何真实数据之前，BI需求收集工作就必须开始了。在这种情况下，数据建模人员无法依赖传统的需求分析技术来收集数据需求，更无从谈起如何实施激进的项目进度计划。   

#### 3.2.1. 主动应用驱动型需求分析所面临的挑战   
Reporting-driven analysis is difficult before data exists
>报表驱动型分析工作无法在数据存在前开展   

如果BI相关利益者没有见到数据或者应用，则他们往往不会有任何进一步的需求构想，这时候传统用户访谈技巧会通通失效。没有现成的报表，数据产品经理甚至无法问出打破受访者沉默的问题：报表还可以如何改进？如何使用这些数据进行决策？同样的，在新业务系统面前，相关人员完全没有测量和使用的经验，因此即使问及更开放的问题（譬如，你会做什么决策或者什么信息能帮你更好更快决策）时，往往也不会得到回应。

#### 3.2.2. 主动数据驱动型分析所面临的挑战    

>没有数据可探查，数据驱动型分析也无从谈起   

即使是推崇数据驱动型分析方法的IT人员，在主动型设计上也无法完全依赖数据驱动型分析方法：如果数据源不存在、或者正在开发中、或者只有少量数据、或者只有测试数据时，数据探查工具和数据模型重构技巧都没有用武之地。即使是基于稳定性强、文档水平高的Packaged APP来搭建的新业务系统，IT人员开展无目标的数据探查工作仍然难度很大，原因就在于只有极少部分的数据库被IT人员所使用和理解，这无疑会很耗费时间却没有任何有价值的产出。

#### 3.2.3. 数据和需求：先有鸡还是先有蛋的困境   

>主动型数仓设计需要全新的数据分析、建模和设计方式   

在IT人员和业务相关人员接触数据并熟悉一段时间之前，他们都不太可能给出真实而详细的BI需求，也正因为此，主动型的数据仓库设计常常无法及时提供准确的信息内容，因而也就无法在数据到来时避免BI任务的堆积。为了解决数据与需求这种“先有鸡还是先有蛋”的困境，主动型数据仓库设计需要新的需求分析和设计方法，这个绝对不会是那些传统的数据建模方法，也不会是那些传统的维度建模方法。

## 4. 敏捷数据仓库设计   

>传统数仓设计方法基本都是遵循近乎串形或者瀑布流方式进行设计和开发  

如图所示，传统的数据仓库建设项目基本都是遵循瀑布流项目管理方式的变种。这条时间线的形状以及术语“瀑布流”，都表示着只有收集完所有细节需求时，项目进程才会继续往下迈进。   
![image](https://user-images.githubusercontent.com/20431533/112653685-a2ec7000-8e89-11eb-9dd1-83b1f131b46e.png)

对数据仓库而言不幸的是，瀑布流方法在前期依赖技巧来尽可能地收集全量需求，却在项目的晚期才为用户推送数据服务和价值，中间存在很大的空窗期。因此无论是理论设计还是实践，纯粹的瀑布流数仓设计（一次性分析，一次性设计，一次性开发）都是比较罕见的。

>维度建模赋能增量开发   

维度建模方式允许开发者以一次一个星型模式的粒度交付BI功能，并且不断收集反馈并作出调整，从而避免了纯粹瀑布流的风险。但即使是维度建模方法，也在采用近乎串行的方式（先是BRUF，再到BDUF）来进行分析和设计，因此也天然带有上面提到限制和延迟影响。   

>敏捷数仓建设赋能迭代和协作   

敏捷数仓建设旨在进一步降低前期分析的风险，通过采用高迭代、增量、协作的设计与开发手段来提供更加及时的BI价值。

>敏捷聚焦于早期和高频的增值软件交付      

通过避免BDUF，取而代之在初次迭代时使用JEDUF（Just enough design upfront）和后续迭代中使用JIT（Just in time）的开发方式，敏捷开发得以专注于早期和高频的软件交付来给客户增加价值，而摒弃一次性收集需求和使用设计文档来给用户画饼。（Talk is cheap, use the data)

>对数仓设计而言，最小可行软件就是一个星型模型   

对敏捷数仓来说，有附加值的的软件组成如下：可查询的数据库模型、ETL过程和BI报表/看板。因此，在每次迭代中可交付的软件模块的最小集合是一个星型模型、填充该星型模型的ETL过程和可访问该模型的BI工具。综上，设计的最小粒度就是“一颗星”。

>敏捷数仓开发依赖于敏捷的数据建模
   
在符合敏捷开发的早期、高频交付要求下，为了设计任意类型的数仓模型，我们需要一些可取代传统串行需求分析与数据建模的敏捷型分析与建模工具。

## 5. 敏捷数据建模      

>敏捷数据建模是协同和不断演进的   

Scott Ambler，多本敏捷建模和敏捷数据库技术书籍的作者(www\.agiledata\.org)，对敏捷数据建模的定义如下：“探索面向数据结构的行为就是数据建模，而以增量、迭代方式进行数据建模是不断演进的，敏捷数据建模正是这样一种以协同方式进行的演进式建模方法。”

协同建模方法包括了需求分析和设计，并让相关利益者积极参与到分析设计过程中。迭代、增量和协同在敏捷开发领域中都有着具体的能带来巨大好处的含义：   

* **协同数据建模**
协同数据建模通过直接和利益相关者共同建模，有效地将分析和设计组合在一起并直入主题的创造数据模型（可运行的软件和文档），而不是仅通过记录数据需求来给用户画饼。

>演进式建模通过不断跟进需求的发展来支持增量式开发   

* **增量数据建模**
当相关利益者了解增量数据建模方法以及我们准备好采取敏捷建模方法时，我们可以收集到更多的需求。增量建模和开发方法正是我们得以支持早期和高频软件交付的重要计划策略。

* **迭代数据建模**
迭代式数据建模方法，通过重构帮助我们更好地理解现有数据需求以及提升现有数据库的模式：修正错误或者增加重要的可获取的数据字段。该方法是一种可增加软件价值的重构策略。
